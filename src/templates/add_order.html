<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Προσθήκη Παραγγελίας</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .invoice-box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .invoice-header {
      border-bottom: 2px solid #dee2e6;
      margin-bottom: 20px;
      padding-bottom: 10px;
    }
    .table td, .table th { vertical-align: middle; }
     
  </style>

</head>
<body>
<div class="container my-4">
  <div class="invoice-box">
    <!-- Header -->
    <div class="invoice-header d-flex justify-content-between align-items-center">
      <h4>Νεα Παραγγελία</h4>
      
    </div>

    <form method="post" action="{{ url_for('add_orders') }}">
      <!-- General Info -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="date" class="form-label">Ημερομηνία</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}">
        </div>

        <script>
          // Get today's date in YYYY-MM-DD format
          const today = new Date().toISOString().split('T')[0];
          // Set the value of the input field
          document.getElementById('date').value = today;
        </script>
        <div class="col-md-7">
          <label for="customer" class="form-label">Πελάτης</label>
          
<select id="customer" name="customer" class="form-select">
  <option value="">Πελάτης</option>
  {% for c in customers %}
  <option value="{{ c[0] }}" data-subtext="{{ c[2] }} {{ c[3] }}">
    {{ c[1]}} | {{c[3]}} | {{c[2] }}
  </option>
  {% endfor %}
</select>

        </div>
        <div class="col-md-1">
          <label for="customer" class="form-label">Προσθήκη</label>
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            <i class="bi bi-plus-circle"></i> 
          </button>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="visa_cash" id="radio1" value="0" checked>
            <label class="form-check-label" for="radio1">
              Μετρητά
            </label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="radio" name="visa_cash" id="radio2" value="1">
            <label class="form-check-label" for="radio2">
              Visa
            </label>
          </div>
      </div>

      <!-- Order Rows -->
      <h5 class="mb-3">Είδη</h5>
      <table class="table table-bordered" id="orderRowsTable">
        <thead class="table-light">
          <tr>
            <th style="width:10%">Έχει Παραγγελθεί</th>
            <th style="width:40%">Περιγραφή</th>
            <th style="width:15%">Ποσότητα</th>
            <th style="width:20%">Τιμή Μονάδας</th>
            <th style="width:20%">Σύνολο</th>
            <th style="width:5%"></th>
          </tr>
        </thead>
        <tbody>
          <tr>
              <td>
  <!-- hidden stores the actual value that will be submitted -->
  <input type="hidden" name="is_ordered[]" class="is-ordered-hidden" value="0">
  <!-- checkbox toggles hidden; no name -->
  <input class="form-check-input is-ordered-checkbox" type="checkbox">
</td>
            <td><input type="text" name="descr[]" class="form-control text-center"></td>
            <td><input type="number" name="qty[]" class="form-control qty text-center" min="1" value="1" step="0.01"></td>
            <td><input type="number" name="value[]" class="form-control price text-center" min="0" step="0.01"></td>
            <td class="line-total">0.00</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row"><i class="bi bi-trash"></i></button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn btn-primary btn-sm mb-3" id="addRow"><i class="bi bi-plus-circle"></i>Προσθήκη Γραμμής</button>

      <!-- Notes + Payment -->
      <div class="row mb-3">
        <div class="col-md-8">
          <label for="notes" class="form-label">Σημειώσεις</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label for="paid" class="form-label">Προκαταβολή</label>
            <input type="number" class="form-control" id="paid" name="paid" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label">Σύνολο</label>
            <h4 id="grandTotal">0.00 €</h4>
          </div>
         <div class="mb-3">
            <label for="paid" class="form-label">Αξία Μετά Εκπτώσεων</label>
            <input type="number" class="form-control" id="afterSales" name="afterSales" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label">Υπόλοιπο</label>
            <h4 id="amountLeft">0.00 €</h4>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="text-end">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-save"></i> Αποθήκευση Παραγγελίας
        </button>
      </div>
    </form>
  </div>
</div>
<!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-lg">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="addCustomerModalLabel">Προσθήκη Νέου Πελάτη</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="addCustomerForm" method="POST" action="{{ url_for('add_order_customers') }}">
          <div class="modal-body">
            <div class="mb-3">
              <label for="name" class="form-label">Επωνυμία</label>
              <input type="text" class="form-control" id="name" name="name" placeholder="Enter full name" required>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" placeholder="name@example.com">
            </div>
            <div class="mb-3">
              <label for="phone1" class="form-label">τηλέφωνο 1</label>
              <input type="text" class="form-control" id="phone1" name="phone1" placeholder="+1 (555) 123-4567" required>
            </div>
            <div class="mb-3">
              <label for="phone2" class="form-label">τηλέφωνο 2</label>
              <input type="text" class="form-control" id="phone2" name="phone2" placeholder="+1 (555) 123-4567">
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Διευθυνση</label>
              <input type="text" class="form-control" id="address" name="address" placeholder="address">
            </div>
            <div class="mb-3">
              <label for="afm" class="form-label">ΑΦΜ</label>
              <input type="text" class="form-control" id="afm" name="afm" placeholder="ΑΦΜ">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Customer</button>
          </div>
        </form>

        <script>
              document.addEventListener("DOMContentLoaded", function() {
                const customerSelect = document.getElementById("customer");
                const customerChoices = new Choices(customerSelect, {
                  searchEnabled: true,
                  searchFloor: 1,
                  shouldSort: false
                });

                // Handle modal form submission via AJAX
                const addCustomerForm = document.getElementById("addCustomerForm");
                addCustomerForm.addEventListener("submit", async function (e) {
                  e.preventDefault();
                  const formData = new FormData(addCustomerForm);

                  const response = await fetch(addCustomerForm.action, {
                    method: "POST",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    body: formData
                  });

                  if (response.ok) {
                    const data = await response.json();

                    // Add new customer dynamically to Choices
                    customerChoices.setChoices([{
                        value: data.id,
                        label: `${data.name} | ${data.phone1|| ''} | ${data.afm || ''}`,
                        selected: true
                    }], 'value', 'label', true);

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
                    modal.hide();

                    // Reset form
                    addCustomerForm.reset();
                  } else {
                    alert("Something went wrong adding the customer!");
                  }
                });
              });
              </script>

      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Add new row
  document.getElementById('addRow').addEventListener('click', function() {
    const tableBody = document.querySelector('#orderRowsTable tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
     <td>
  <!-- hidden stores the actual value that will be submitted -->
  <input type="hidden" name="is_ordered[]" class="is-ordered-hidden" value="0">
  <!-- checkbox toggles hidden; no name -->
  <input class="form-check-input is-ordered-checkbox" type="checkbox">
</td>
      <td><input type="text" name="descr[]" class="form-control"></td>
      <td><input type="number" name="qty[]" class="form-control qty" min="1" value="1" step="0.01"></td>
      <td><input type="number" name="value[]" class="form-control price" min="0" step="0.01"></td>
      <td class="line-total">0.00</td>
      <td><button type="button" class="btn btn-danger btn-sm remove-row"><i class="bi bi-trash"></i></button></td>
    `;
    tableBody.appendChild(newRow);
  });

  // Event delegation for removing rows
  document.querySelector('#orderRowsTable').addEventListener('click', function(e) {
    if (e.target.closest('.remove-row')) {
      e.target.closest('tr').remove();
      updateTotals();
    }
  });

  // Update totals dynamically
  document.addEventListener('input', function(e) {
    if (e.target.classList.contains('qty') || e.target.classList.contains('price')) {
      updateTotals();
    }
  });

 function updateTotals() {
  let grandTotal = 0;

  document.querySelectorAll('#orderRowsTable tbody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.qty')?.value) || 0;
    const price = parseFloat(row.querySelector('.price')?.value) || 0;
    const lineTotal = qty * price;
    const lineTotalCell = row.querySelector('.line-total');
    if (lineTotalCell) lineTotalCell.textContent = lineTotal.toFixed(2);
    grandTotal += lineTotal;
  });

  // Update grand total display
  document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' €';

  // Inputs
  const paidInput = document.getElementById('paid');
  const afterSalesInput = document.getElementById('afterSales');
  const amountLeftDisplay = document.getElementById('amountLeft');

  if (!amountLeftDisplay) return;

  const paid = parseFloat(paidInput?.value) || 0;
  const afterSales = parseFloat(afterSalesInput?.value);

  // Determine which total to use for remaining amount
  const baseTotal = !isNaN(afterSales) && afterSales > 0 ? afterSales : grandTotal;
  const amountLeft = baseTotal - paid;
  if(!isNaN(afterSales) && afterSales > 0 ){
    document.getElementById('grandTotal').style.color="red";
    document.getElementById('grandTotal').style.textDecoration = "line-through";
  }
  amountLeftDisplay.textContent = amountLeft.toFixed(2) + ' €';
}

document.addEventListener('DOMContentLoaded', () => {
  // Initial run
  updateTotals();

  // Add listeners
  document.querySelectorAll('.qty, .price').forEach(input => {
    input.addEventListener('input', updateTotals);
  });

  const paidInput = document.getElementById('paid');
  if (paidInput) paidInput.addEventListener('input', updateTotals);

  const afterSalesInput = document.getElementById('afterSales');
  if (afterSalesInput) afterSalesInput.addEventListener('input', updateTotals);
});
document.querySelector('#orderRowsTable').addEventListener('change', function(e) {
  if (e.target.matches('.is-ordered-checkbox')) {
    const tr = e.target.closest('tr');
    const hidden = tr.querySelector('.is-ordered-hidden');
    hidden.value = e.target.checked ? '1' : '0';
  }
});
</script>

</body>
</html>
